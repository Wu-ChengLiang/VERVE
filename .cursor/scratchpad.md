# 大众点评记忆功能实施计划

## 背景和动机

用户需要为大众点评AI客服系统添加记忆功能，解决以下核心问题：
- **当前无持久记忆**：每次AI回复都是独立的，缺乏上下文连续性
- **聊天对象混合**：不同客户的消息会混合处理，导致回复错乱
- **双向记录缺失**：只记录客户消息，不记录AI回复，无法形成完整对话链

**核心需求**：
1. 聊天对象切换检测（通过联系人列表点击监听）
2. 双向消息记录（客户消息 + AI回复）
3. 上下文传递给AI生成连续性回复
4. 会话结束自动保存
5. **最小改动原则**：基于现有代码结构进行增量改进

## 关键挑战和分析

### 技术挑战
1. **聊天对象识别**：URL不变，需通过DOM事件监听联系人切换
2. **记忆存储设计**：前端临时存储 vs 后端持久化的平衡
3. **消息归属判断**：区分客户消息、AI回复、系统消息
4. **性能考虑**：记忆数据不能无限增长

### 架构约束
- 必须基于现有WebSocket通信机制
- 不能大幅修改现有代码结构
- 需要兼容现有的数据提取逻辑

## 高层任务拆分

### Phase 1: 前端记忆基础架构 (最小改动)
- [ ] **任务1.1**: 在`content.js`中添加记忆管理属性
  - 成功标准：添加`conversationMemory`、`currentChatId`等属性
  - 影响：仅在构造函数中添加4-5行代码
  
- [ ] **任务1.2**: 实现联系人切换检测
  - 成功标准：点击联系人时能检测到切换事件并获取联系人信息
  - 影响：修改现有`getContactInfo`方法，添加切换检测逻辑

- [ ] **任务1.3**: 扩展消息提取逻辑
  - 成功标准：消息提取时自动添加到记忆中，区分消息类型
  - 影响：修改`extractChatMessages`方法，添加记忆存储

### Phase 2: WebSocket协议扩展
- [ ] **任务2.1**: 新增记忆相关消息类型
  - 成功标准：定义`chat_context_switch`、`memory_update`等消息类型
  - 影响：修改`sendDataToBackground`方法参数结构

- [ ] **任务2.2**: 实现记忆数据传输
  - 成功标准：聊天切换时发送记忆清空请求，消息提取时发送记忆更新
  - 影响：在现有数据发送逻辑中添加记忆相关字段

### Phase 3: 后端记忆处理
- [ ] **任务3.1**: 扩展后端消息处理
  - 成功标准：`server.py`能接收并处理记忆相关消息
  - 影响：在`process_message_by_type`中添加新的消息类型处理

- [ ] **任务3.2**: AI客户端记忆集成
  - 成功标准：AI生成回复时能获取历史对话上下文
  - 影响：修改`AIClient.generate_customer_service_reply`方法

### Phase 4: 自动保存机制
- [ ] **任务4.1**: 会话结束检测
  - 成功标准：检测到切换或页面关闭时自动保存记忆
  - 影响：添加页面卸载事件监听

- [ ] **任务4.2**: 记忆持久化存储
  - 成功标准：记忆数据能保存到本地文件，下次加载时恢复
  - 影响：后端添加文件操作逻辑

## 项目状态看板

### 待开始 (TODO)
- [ ] 任务1.1: 添加记忆管理属性
- [ ] 任务1.2: 联系人切换检测
- [ ] 任务1.3: 扩展消息提取逻辑
- [ ] 任务2.1: WebSocket协议扩展
- [ ] 任务2.2: 记忆数据传输
- [ ] 任务3.1: 后端记忆处理
- [ ] 任务3.2: AI客户端记忆集成  
- [ ] 任务4.1: 会话结束检测
- [ ] 任务4.2: 记忆持久化存储

### 进行中 (IN PROGRESS)
- 等待执行者开始

### 已完成 (DONE)
- 无

### 被阻塞 (BLOCKED)
- 无

## 当前状态/进度跟踪

**当前阶段**: 规划完成，等待执行者开始实施
**下一步行动**: 执行者开始任务1.1 - 添加记忆管理属性

## 执行者反馈或请求帮助

*等待执行者反馈*

## 经验教训

### 已知约束
- 不能大幅修改现有代码结构
- 聊天对象切换通过联系人点击检测，不是URL变化
- 需要兼容现有的批量提取功能

### 设计原则
- 最小改动：每个任务尽量只修改1-2个方法
- 渐进增强：新功能不影响现有功能
- 向后兼容：保持现有API不变
